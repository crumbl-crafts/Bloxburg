<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crumbl Crafts - Builder Operations</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --bg: #030303;
            --panel: rgba(12, 12, 12, 0.9);
            --border: rgba(255, 223, 178, 0.2);
            --gold: #f4cf91;
            --accent: #e4983d;
            --muted: #8f8f8f;
            --success: #6de3b5;
            --danger: #ff6f77;
            --font: 'Space Grotesk', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: var(--font);
            background: radial-gradient(circle at top, rgba(244, 207, 145, 0.15), transparent),
                        linear-gradient(135deg, #050505 0%, #0b0b0b 50%, #040404 100%);
            color: #fff;
            padding: 32px;
        }

        .glow {
            position: fixed;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(circle at 20% 20%, rgba(244, 207, 145, 0.35), transparent 45%),
                        radial-gradient(circle at 80% 0%, rgba(249, 179, 109, 0.25), transparent 35%);
            z-index: 0;
            filter: blur(40px);
        }

        .shell {
            position: relative;
            max-width: 1400px;
            margin: 0 auto;
            z-index: 1;
        }

        .hero {
            border: 1px solid var(--border);
            border-radius: 28px;
            padding: 32px;
            background: linear-gradient(120deg, rgba(12, 12, 12, 0.9), rgba(20, 20, 20, 0.9));
            box-shadow: 0 40px 120px rgba(0, 0, 0, 0.65);
            margin-bottom: 32px;
        }

        .hero-top {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 24px;
            align-items: center;
        }

        .brand-copy {
            max-width: 560px;
        }

        .eyebrow {
            letter-spacing: 0.3em;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--gold);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .eyebrow::before {
            content: '';
            width: 32px;
            height: 1px;
            background: var(--gold);
            display: inline-block;
        }

        h1 {
            font-size: clamp(2.5rem, 4vw, 3.5rem);
            margin: 12px 0 8px;
        }

        .tagline {
            color: rgba(255, 255, 255, 0.85);
            font-size: 1.05rem;
            line-height: 1.6;
        }

        .status-block {
            background: rgba(255, 255, 255, 0.04);
            border-radius: 20px;
            padding: 20px 24px;
            min-width: 260px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 12px;
        }

        .status-pill::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-pill.live { color: var(--success); }
        .status-pill.snapshot { color: var(--gold); }
        .status-pill.placeholder { color: var(--danger); }
        .status-pill.loading { color: var(--muted); }

        .status-detail {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
            margin-bottom: 6px;
        }

        .status-timestamp {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
        }

        .panel {
            background: var(--panel);
            border-radius: 24px;
            border: 1px solid var(--border);
            padding: 24px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
        }

        .panel h2 {
            margin: 0 0 18px;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--gold);
        }

        .panel.span-2 {
            grid-column: span 2;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 18px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: rgba(244, 207, 145, 0.15);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            color: var(--gold);
        }

        .stat-value {
            font-size: 1.9rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--muted);
            font-size: 0.9rem;
            letter-spacing: 0.08em;
        }

        .server-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .server-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.02);
        }

        .builders-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .builder-item {
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.04);
            border-radius: 16px;
            padding: 16px;
        }

        .builder-rank {
            width: 42px;
            height: 42px;
            border-radius: 16px;
            background: rgba(244, 207, 145, 0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--gold);
        }

        .builder-info {
            flex: 1;
        }

        .builder-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .builder-stats {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .builder-medal {
            font-size: 1.3rem;
        }

        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 14px;
            max-height: 420px;
            overflow: hidden auto;
        }

        .activity-item {
            display: flex;
            gap: 16px;
            padding: 14px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.04);
            text-decoration: none;
            color: inherit;
            transition: transform 0.2s ease;
        }

        .activity-item:hover {
            transform: translateY(-2px);
            border-color: rgba(244, 207, 145, 0.28);
        }

        .activity-icon {
            width: 42px;
            height: 42px;
            border-radius: 14px;
            background: rgba(244, 207, 145, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gold);
            flex-shrink: 0;
        }

        .activity-msg {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .activity-time {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .pipeline-list,
        .insights-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .pipeline-item,
        .insight-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.03);
            padding: 16px;
            border-radius: 16px;
        }

        .pipeline-label {
            text-transform: uppercase;
            color: var(--muted);
            font-size: 0.8rem;
            letter-spacing: 0.2em;
            margin-bottom: 8px;
        }

        .pipeline-value {
            font-size: 2rem;
            font-weight: 600;
        }

        .pipeline-trend {
            color: var(--gold);
            font-size: 0.95rem;
        }

        .insight-title {
            font-size: 1rem;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .insight-detail {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 4px;
        }

        .insight-score {
            font-size: 0.85rem;
            letter-spacing: 0.1em;
            color: var(--muted);
        }

        .loading {
            color: var(--muted);
            font-style: italic;
        }

        .footer-note {
            margin-top: 32px;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            body { padding: 20px; }
            .hero-top { flex-direction: column; align-items: flex-start; }
            .panel.span-2 { grid-column: span 1; }
        }
    </style>
</head>
<body>
    <div class="glow" aria-hidden="true"></div>
    <div class="shell">
        <header class="hero">
            <div class="hero-top">
                <div class="brand-copy">
                    <div class="eyebrow">Crumbl Crafts - Live Ops</div>
                    <h1>Luxury Builder Pipeline Command</h1>
                    <p class="tagline">
                        High fidelity telemetry for active commissions, shop velocity, and response discipline across the Crumbl Crafts collective.
                    </p>
                </div>
                <div class="status-block">
                    <div id="dataStatus" class="status-pill loading">Connecting</div>
                    <div id="statusDetail" class="status-detail">Awaiting first data packet...</div>
                    <div id="statusTimestamp" class="status-timestamp">--</div>
                </div>
            </div>
        </header>

        <main class="grid">
            <section class="panel span-2">
                <h2>Summary Pulse</h2>
                <div id="summaryMetrics" class="summary-grid">
                    <div class="stat-card loading">Loading summary...</div>
                </div>
            </section>

            <section class="panel">
                <h2>Server Health</h2>
                <ul id="serverStats" class="server-list">
                    <li class="loading">Loading server stats...</li>
                </ul>
            </section>

            <section class="panel">
                <h2>Builder Podium</h2>
                <ul id="buildersList" class="builders-list">
                    <li class="loading">Loading builders...</li>
                </ul>
            </section>

            <section class="panel span-2">
                <h2>Activity Radar</h2>
                <div id="activityFeed" class="activity-feed">
                    <div class="loading">Listening for activity...</div>
                </div>
            </section>

            <section class="panel">
                <h2>Pipeline Load</h2>
                <ul id="pipelineList" class="pipeline-list">
                    <li class="loading">Loading pipeline...</li>
                </ul>
            </section>

            <section class="panel">
                <h2>Insights Desk</h2>
                <ul id="insightsList" class="insights-list">
                    <li class="loading">Loading insights...</li>
                </ul>
            </section>
        </main>

        <div class="footer-note">
            Data refreshes continuously. Remote API -> site snapshot -> curated placeholder.
        </div>
    </div>

    <script>
        const REMOTE_ENDPOINT = 'https://your-metrics-endpoint.example.com/api/metrics';
        const LOCAL_SNAPSHOT = 'site_metrics.json';
        const POLL_INTERVAL_MS = 10000;

        const fallbackData = {
            summary: {
                builder_count: 18,
                total_completed: 642,
                total_requests: 810,
                total_ratings: 214,
                request_completion_ratio: 0.79,
            },
            server: {
                total_members: 4200,
                joined_today: 38,
                active_shops: 9,
                avg_response_time: 7260,
            },
            topBuilders: [
                { shop_name: 'Maison Noir', completed_projects: 188, average_rating: 4.98 },
                { shop_name: 'Atelier Hikari', completed_projects: 161, average_rating: 4.92 },
                { shop_name: 'Velvet Forge', completed_projects: 140, average_rating: 4.88 },
            ],
            activityLog: [
                { type: 'accepted', message: 'Velvet Forge accepted a luxury penthouse commission', timestamp: Math.floor(Date.now() / 1000) - 900 },
                { type: 'rating', message: 'Client rated Atelier Hikari &#9733;4.9 for skyline loft', timestamp: Math.floor(Date.now() / 1000) - 3600 },
                { type: 'new_request_thread', message: 'Maison Noir opened "Sable Estate" request thread', timestamp: Math.floor(Date.now() / 1000) - 7200 },
            ],
            pipeline: [
                { label: 'Queued Requests', value: 24, trend: '4 new today' },
                { label: 'Active Builds', value: 11, trend: '9 shops accepting' },
                { label: 'Delivered 7d', value: 47, trend: '+ realtime' },
            ],
            insights: [
                { title: 'Completion Rate', detail: '79% delivery ratio', score: 'On track' },
                { title: 'Request Velocity', detail: '9 new luxury briefs today', score: 'Stable' },
                { title: 'Response Discipline', detail: 'Avg response 2h', score: 'Maintain' },
            ],
            meta: {
                generated_at: Date.now() / 1000,
                mode: 'placeholder',
            },
        };

        async function fetchMetrics() {
            updateStatus('loading', 'Syncing metrics stream...');
            try {
                const live = await fetchJson(REMOTE_ENDPOINT);
                hydrateDashboard(live, 'live');
                return;
            } catch (err) {
                console.warn('Live endpoint unavailable', err);
            }

            try {
                const snapshot = await fetchJson(LOCAL_SNAPSHOT + '?t=' + Date.now());
                hydrateDashboard(snapshot, 'snapshot');
                return;
            } catch (err) {
                console.warn('Snapshot fallback unavailable', err);
            }

            hydrateDashboard(fallbackData, 'placeholder');
        }

        async function fetchJson(url) {
            const res = await fetch(url, { cache: 'no-store' });
            if (!res.ok) {
                throw new Error('Bad response');
            }
            return res.json();
        }

        function hydrateDashboard(payload, source) {
            if (!payload) {
                payload = fallbackData;
                source = 'placeholder';
            }
            updateStatus(source, describeSource(source));
            updateSummary(payload.summary, payload.server);
            updateServer(payload.server);
            updateBuilders(payload.topBuilders);
            updateActivity(payload.activityLog);
            updatePipeline(payload.pipeline);
            updateInsights(payload.insights);
            updateTimestamp(payload.meta);
        }

        function describeSource(source) {
            switch(source) {
                case 'live': return 'Streaming live metrics';
                case 'snapshot': return 'Serving cached snapshot';
                case 'placeholder': return 'Showing curated baseline';
                default: return 'Synchronizing...';
            }
        }

        function updateStatus(state, detail) {
            const badge = document.getElementById('dataStatus');
            const statusDetail = document.getElementById('statusDetail');
            badge.className = `status-pill ${state}`;
            badge.textContent = state === 'live' ? 'Live' :
                state === 'snapshot' ? 'Snapshot' :
                state === 'placeholder' ? 'Offline Mode' : 'Connecting';
            statusDetail.textContent = detail;
        }

        function updateTimestamp(meta = {}) {
            const stamp = document.getElementById('statusTimestamp');
            const generated = meta.generated_at ? new Date(meta.generated_at * 1000) : new Date();
            stamp.textContent = `Last update ${generated.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        }

        function updateSummary(summary = {}, server = {}) {
            const container = document.getElementById('summaryMetrics');
            if (!summary || Object.keys(summary).length === 0) {
                container.innerHTML = '<div class="stat-card loading">Summary unavailable</div>';
                return;
            }
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-people-group"></i></div>
                    <div class="stat-value">${summary.builder_count ?? 0}</div>
                    <div class="stat-label">Active Builders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-trophy"></i></div>
                    <div class="stat-value">${summary.total_completed ?? 0}</div>
                    <div class="stat-label">Projects Delivered</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="stat-value">${((summary.request_completion_ratio ?? 0) * 100).toFixed(1)}%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                    <div class="stat-value">${formatDuration(server?.avg_response_time)}</div>
                    <div class="stat-label">Avg Response</div>
                </div>
            `;
        }

        function updateServer(server = {}) {
            const list = document.getElementById('serverStats');
            if (!server || Object.keys(server).length === 0) {
                list.innerHTML = '<li class="loading">No server telemetry</li>';
                return;
            }
            list.innerHTML = `
                <li><span>Total Members</span><strong>${server.total_members ?? 0}</strong></li>
                <li><span>Joined Today</span><strong>${server.joined_today ?? 0}</strong></li>
                <li><span>Active Shops</span><strong>${server.active_shops ?? 0}</strong></li>
                <li><span>Avg Response</span><strong>${formatDuration(server.avg_response_time)}</strong></li>
            `;
        }

        function updateBuilders(builders = []) {
            const list = document.getElementById('buildersList');
            if (!builders.length) {
                list.innerHTML = '<li class="loading">No builder data available</li>';
                return;
            }
            list.innerHTML = builders.slice(0, 4).map((builder, idx) => `
                <li class="builder-item">
                    <div class="builder-rank">#${idx + 1}</div>
                    <div class="builder-info">
                        <div class="builder-name">${builder.shop_name ?? 'Unknown'}</div>
                        <div class="builder-stats">
                            ${builder.completed_projects ?? 0} projects &bull; &#9733; ${(builder.average_rating ?? 0).toFixed(2)}
                        </div>
                    </div>
                    <div class="builder-medal">
                        ${renderMedal(idx)}
                    </div>
                </li>
            `).join('');
        }

        function renderMedal(index) {
            if (index === 0) return '<i class="fas fa-medal" style="color:#FFD700"></i>';
            if (index === 1) return '<i class="fas fa-medal" style="color:#C0C0C0"></i>';
            if (index === 2) return '<i class="fas fa-medal" style="color:#CD7F32"></i>';
            return '';
        }

        function updateActivity(logs = []) {
            const feed = document.getElementById('activityFeed');
            if (!logs.length) {
                feed.innerHTML = '<div class="loading">No recent activity</div>';
                return;
            }
            feed.innerHTML = logs.slice(0, 8).map(log => {
                const icon = getIconForType(log.type);
                const timeAgo = getTimeAgo(log.timestamp);
                const tag = log.url ? 'a' : 'div';
                const href = log.url ? `href="${log.url}" target="_blank" rel="noopener"` : '';
                return `
                    <${tag} class="activity-item" ${href}>
                        <div class="activity-icon"><i class="fas ${icon}"></i></div>
                        <div>
                            <div class="activity-msg">${log.message ?? 'Event logged'}</div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    </${tag}>
                `;
            }).join('');
        }

        function updatePipeline(items = []) {
            const list = document.getElementById('pipelineList');
            if (!items.length) {
                list.innerHTML = '<li class="loading">Pipeline data unavailable</li>';
                return;
            }
            list.innerHTML = items.map(item => `
                <li class="pipeline-item">
                    <div class="pipeline-label">${item.label ?? 'Metric'}</div>
                    <div class="pipeline-value">${item.value ?? 0}</div>
                    <div class="pipeline-trend">${item.trend ?? ''}</div>
                </li>
            `).join('');
        }

        function updateInsights(items = []) {
            const list = document.getElementById('insightsList');
            if (!items.length) {
                list.innerHTML = '<li class="loading">Insights offline</li>';
                return;
            }
            list.innerHTML = items.map(item => `
                <li class="insight-item">
                    <div class="insight-title">${item.title ?? 'Insight'}</div>
                    <div class="insight-detail">${item.detail ?? ''}</div>
                    <div class="insight-score">${item.score ?? ''}</div>
                </li>
            `).join('');
        }

        function formatDuration(seconds) {
            if (!seconds || seconds <= 0) return 'N/A';
            if (seconds < 60) return `${Math.round(seconds)}s`;
            const mins = Math.floor(seconds / 60);
            if (mins < 60) return `${mins}m`;
            const hrs = Math.floor(mins / 60);
            if (hrs < 24) return `${hrs}h`;
            const days = Math.floor(hrs / 24);
            return `${days}d`;
        }

        function getIconForType(type) {
            switch(type) {
                case 'sent': return 'fa-paper-plane';
                case 'accepted': return 'fa-handshake';
                case 'rejected': return 'fa-times-circle';
                case 'completed': return 'fa-check-double';
                case 'member_join': return 'fa-user-plus';
                case 'member_leave': return 'fa-user-minus';
                case 'rating': return 'fa-star';
                case 'new_request_thread': return 'fa-comment-dots';
                default: return 'fa-info-circle';
            }
        }

        function getTimeAgo(timestamp) {
            if (!timestamp) return 'Just now';
            const now = Math.floor(Date.now() / 1000);
            const delta = Math.max(0, now - timestamp);
            if (delta < 60) return 'Just now';
            const mins = Math.floor(delta / 60);
            if (mins < 60) return `${mins}m ago`;
            const hrs = Math.floor(mins / 60);
            if (hrs < 24) return `${hrs}h ago`;
            const days = Math.floor(hrs / 24);
            return `${days}d ago`;
        }

        fetchMetrics();
        setInterval(fetchMetrics, POLL_INTERVAL_MS);
    </script>
</body>
</html>
